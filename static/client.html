<html>
  <head>
    <style>
    .poasted, .username, .poast {
      padding-right: 5px;
    }

    .username {
      text-align: right;
    }
    </style>
  </head>
  <body>
    <h1>box of shouts</h1>

    <form id="shoutbox-form">
      <input type="text" id="naem" placeholder="naem">
      <input type="text" id="poast" placeholder="poast">

      <button type="submit">Send your message</button>
    </form>

    <!-- poasts go here -->
    <div id="poasts">

    </div>

  </body>

  <footer>
  <script type="text/javascript">

    function isBlank(str) {
        return (!str || /^\s*$/.test(str))
    }

    function pad(val, len) {
        val = String(val);
        len = len || 2;
        while (val.length < len) val = "0" + val;
        return val;
    };

    var form = document.querySelector("#shoutbox-form")
    form.onsubmit = function submitForm(event) {
      event.preventDefault()

      var naemElement = form.elements["naem"]
      var poastElement = form.elements["poast"]

      var message = {
        Username: naemElement.value,
        Poast: poastElement.value
      }

      if (isBlank(message.Username) || isBlank(message.Poast)) {
        alert("Fill in a username and message y0")
        return
      }

      if (message.Poast.length > 1000) {
        alert("Message too long; arbitrary limit is 1000 characters");
        return
      }

      if (message.Username.length > 20) {
        alert("Username too long; max 20 characters")
        return
      }

      poastElement.value = "" // boom!

      var request = new XMLHttpRequest()
      request.onload = poastRequestListener
      request.open("POST", "/poast")
      request.send(JSON.stringify(message))

      return false
    }

    function parseSmileys(poast) {
      return poast.replace(":monster:", "<img src=\"http://thelifestream.net/forums/images/smilies/cookiemonster.gif\">");
    }

    function poastRequestListener() {
      poasts = JSON.parse(this.responseText)
      poasts.forEach(function (poast) {
        poast.Poasted = new Date(Date.parse(poast.Poasted))
        poast.Poast = parseSmileys(poast.Poast)
      })

      poasts.sort(function (a, b) {
          return a.Poasted.getTime() - b.Poasted.getTime()
      }).reverse()

      // clear shit. Stoopid imo.
      var poastContainer = document.querySelector("#poasts")
      while (poastContainer.firstChild) {
          poastContainer.removeChild(poastContainer.firstChild)
      }

      poasts.forEach(function(poast) {
        var timeSpan = document.createElement("td")
        timeSpan.className = "poasted"
        var poasted = new Date(poast.Poasted)
        timeSpan.appendChild(document.createTextNode("[" + pad(poasted.getHours(), 2) + ":" + pad(poasted.getMinutes(), 2) + ":" + pad(poasted.getSeconds(), 2) + "] "))

        var usernameSpan = document.createElement("td")
        usernameSpan.className = "username"
        usernameSpan.appendChild(document.createTextNode(poast.Username + ": "))

        var poastSpan = document.createElement("td")
        poastSpan.className = "poast"
        poastSpan.innerHTML = poast.Poast

        var poastDiv = document.createElement("tr")
        poastDiv.appendChild(timeSpan)
        poastDiv.appendChild(usernameSpan)
        poastDiv.appendChild(poastSpan)

        poastContainer.appendChild(poastDiv)
      })
    }

    function loadNewPoasts() {
      console.log("Loading new poasts")

      var request = new XMLHttpRequest()
      request.onload = poastRequestListener
      request.open("GET", "/poast")
      request.send()
    }

    setInterval(loadNewPoasts, 5000)
    loadNewPoasts()

  </script>
</html>
